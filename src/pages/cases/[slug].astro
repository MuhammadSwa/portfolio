---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import CaseDetail from '../../components/CaseDetail';
import Footer from '../../components/Footer.astro';

export async function getStaticPaths() {
  const cases = await getCollection('cases');
  return cases.map((caseEntry) => ({
    params: { slug: caseEntry.id },
    props: { caseEntry },
  }));
}

const { caseEntry } = Astro.props;
const { Content } = await render(caseEntry);

// Serialize images - image() schema returns ImageMetadata objects with src property
const serializedImages = caseEntry.data.images.map((img: any) => ({
  src: typeof img.src === 'string' ? img.src : img.src.src,
  alt: img.alt,
  stage: img.stage,
}));

const caseData = {
  ...caseEntry.data,
  images: serializedImages,
  date: caseEntry.data.date.toISOString(),
  id: caseEntry.id,
};

const categoryLabels: Record<string, string> = {
  'restorations': 'Restorations',
  'endodontics': 'Endodontics',
  'fixed-prosthodontics': 'Fixed Prosthodontics',
  'extractions': 'Extractions',
  'periodontics': 'Periodontics',
  'other': 'Other',
};

const outcomeColors: Record<string, string> = {
  'excellent': 'bg-emerald-900/50 text-emerald-300 border border-emerald-700',
  'good': 'bg-blue-900/50 text-blue-300 border border-blue-700',
  'satisfactory': 'bg-amber-900/50 text-amber-300 border border-amber-700',
  'needs-follow-up': 'bg-orange-900/50 text-orange-300 border border-orange-700',
};
---

<BaseLayout title={`${caseEntry.data.title} | Dr. Zahrawi`} description={`Dental case: ${caseEntry.data.title}`}>
    <!-- Navigation -->
    <nav class="bg-slate-900/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
        <a href={import.meta.env.BASE_URL} class="flex items-center gap-2 text-slate-200 hover:text-teal-400 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="font-medium">Back to Portfolio</span>
          </a>
          <span class="text-sm text-slate-400">
            {categoryLabels[caseEntry.data.category]}
          </span>
        </div>
      </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Case Header -->
      <header class="mb-12">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <span class="px-3 py-1 bg-teal-900/50 text-teal-300 border border-teal-700 rounded-full text-sm font-medium">
            {categoryLabels[caseEntry.data.category]}
          </span>
          {caseEntry.data.outcome && (
            <span class={`px-3 py-1 rounded-full text-sm font-medium ${outcomeColors[caseEntry.data.outcome]}`}>
              {caseEntry.data.outcome.charAt(0).toUpperCase() + caseEntry.data.outcome.slice(1).replace('-', ' ')}
            </span>
          )}
          {caseEntry.data.featured && (
            <span class="px-3 py-1 bg-amber-900/50 text-amber-300 border border-amber-700 rounded-full text-sm font-medium">
              ‚≠ê Featured
            </span>
          )}
        </div>
        
        <h1 class="text-3xl md:text-4xl font-serif font-semibold text-slate-100 mb-4">
          {caseEntry.data.title}
        </h1>
        
        <div class="flex flex-wrap gap-4 text-sm text-slate-400">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            {caseEntry.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          </span>
          {caseEntry.data.toothNumber && (
            <span class="flex items-center gap-1">
              ü¶∑ Tooth #{caseEntry.data.toothNumber}
            </span>
          )}
          {caseEntry.data.patientAge && caseEntry.data.patientGender && (
            <span class="flex items-center gap-1">
              üë§ {caseEntry.data.patientAge}yo {caseEntry.data.patientGender}
            </span>
          )}
        </div>
      </header>

      <!-- Image Gallery -->
      <CaseDetail client:load caseData={caseData} />

      <!-- Case Information Grid -->
      <div class="grid md:grid-cols-2 gap-6 mb-12">
        {caseEntry.data.chiefComplaint && (
          <div class="bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-700">
            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Chief Complaint</h3>
            <p class="text-slate-200">{caseEntry.data.chiefComplaint}</p>
          </div>
        )}
        
        {caseEntry.data.diagnosis && (
          <div class="bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-700">
            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Diagnosis</h3>
            <p class="text-slate-200">{caseEntry.data.diagnosis}</p>
          </div>
        )}
        
        <div class="bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-700">
          <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Treatment</h3>
          <p class="text-slate-200">{caseEntry.data.treatment}</p>
        </div>
        
        {caseEntry.data.materials && caseEntry.data.materials.length > 0 && (
          <div class="bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-700">
            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Materials Used</h3>
            <ul class="space-y-1">
              {caseEntry.data.materials.map((material: string) => (
                <li class="text-slate-200 flex items-center gap-2">
                  <span class="w-1.5 h-1.5 bg-teal-500 rounded-full"></span>
                  {material}
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>


      <!-- Learnings Section -->
      {caseEntry.data.learnings && (
        <div class="bg-emerald-900/30 rounded-xl p-6 mb-8 border border-emerald-700">
          <h3 class="text-lg font-semibold text-emerald-300 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            Key Learnings
          </h3>
          <p class="text-emerald-200">{caseEntry.data.learnings}</p>
        </div>
      )}

      <!-- Follow-up -->
      {caseEntry.data.followUp && (
        <div class="bg-blue-900/30 rounded-xl p-6 mb-8 border border-blue-700">
          <h3 class="text-lg font-semibold text-blue-300 mb-2 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Follow-up Plan
          </h3>
          <p class="text-blue-200">{caseEntry.data.followUp}</p>
        </div>
      )}

      <!-- Difficulties Section -->
      {caseEntry.data.difficulties && caseEntry.data.difficulties.length > 0 && (
        <div class="bg-amber-900/30 rounded-xl p-6 mb-8 border border-amber-700">
          <h3 class="text-lg font-semibold text-amber-300 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Challenges & Difficulties
          </h3>
          <ul class="space-y-2">
            {caseEntry.data.difficulties.map((difficulty: string) => (
              <li class="text-amber-200 flex items-start gap-2">
                <span class="mt-1.5 w-1.5 h-1.5 bg-amber-400 rounded-full flex-shrink-0"></span>
                {difficulty}
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- Case Notes (Markdown Content) -->
      <div class="bg-slate-800 rounded-xl p-6 md:p-8 shadow-sm border border-slate-700">
        <div class="markdown-content">
          <Content />
        </div>
      </div>


      <!-- Tags -->
      {caseEntry.data.tags && caseEntry.data.tags.length > 0 && (
        <div class="mt-8 flex flex-wrap gap-2">
          {caseEntry.data.tags.map((tag: string) => (
            <span class="px-3 py-1 bg-slate-800 text-slate-300 border border-slate-700 rounded-full text-sm">
              #{tag}
            </span>
          ))}
        </div>
      )}
    </main>
    
    <Footer />
</BaseLayout>

<style is:global>
  .markdown-content {
    color: #e2e8f0;
    font-size: 1.125rem;
    line-height: 1.75;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  /* Headings with gradient accents */
  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4,
  .markdown-content h5,
  .markdown-content h6 {
    background: linear-gradient(135deg, #5eead4 0%, #3b82f6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 1em;
    letter-spacing: -0.02em;
  }

  .markdown-content h1 {
    font-size: 2.5rem;
    margin-top: 0;
    margin-bottom: 1.5rem;
  }

  .markdown-content h2 {
    font-size: 2rem;
    border-bottom: 2px solid;
    border-image: linear-gradient(90deg, #5eead4, #3b82f6, transparent) 1;
    padding-bottom: 0.5rem;
    margin-top: 2.5rem;
  }

  .markdown-content h3 {
    font-size: 1.625rem;
    margin-top: 2rem;
  }

  .markdown-content h4 {
    font-size: 1.375rem;
  }

  /* Paragraphs with better spacing */
  .markdown-content p {
    margin-top: 1.5em;
    margin-bottom: 1.5em;
  }

  /* Stylish links with hover effects */
  .markdown-content a {
    color: #5eead4;
    text-decoration: none;
    position: relative;
    font-weight: 500;
    transition: color 0.3s ease;
  }

  .markdown-content a::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 2px;
    bottom: -2px;
    left: 0;
    background: linear-gradient(90deg, #5eead4, #3b82f6);
    transform: scaleX(0);
    transform-origin: bottom right;
    transition: transform 0.3s ease;
  }

  .markdown-content a:hover {
    color: #2dd4bf;
  }

  .markdown-content a:hover::after {
    transform: scaleX(1);
    transform-origin: bottom left;
  }

  /* Enhanced lists with custom markers */
  .markdown-content ul,
  .markdown-content ol {
    margin-top: 1.5em;
    margin-bottom: 1.5em;
    padding-left: 1.75em;
  }

  .markdown-content li {
    margin-top: 0.75em;
    margin-bottom: 0.75em;
    padding-left: 0.5em;
  }

  .markdown-content ul > li {
    position: relative;
  }

  .markdown-content ul > li::marker {
    content: '‚ñπ ';
    color: #5eead4;
    font-size: 1.2em;
  }

  .markdown-content ol {
    counter-reset: item;
  }

  .markdown-content ol > li {
    counter-increment: item;
  }

  .markdown-content ol > li::marker {
    content: counter(item) '. ';
    color: #3b82f6;
    font-weight: 600;
  }

  .markdown-content ul ul,
  .markdown-content ul ol,
  .markdown-content ol ul,
  .markdown-content ol ol {
    margin-top: 0.75em;
    margin-bottom: 0.75em;
  }

  /* Code blocks with glassmorphism effect */
  .markdown-content pre {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(94, 234, 212, 0.2);
    border-radius: 0.75rem;
    padding: 1.5rem;
    overflow-x: auto;
    margin-top: 2em;
    margin-bottom: 2em;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    position: relative;
  }

  .markdown-content pre::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #5eead4, #3b82f6);
  }

  .markdown-content code {
    color: #e2e8f0;
    font-size: 0.9em;
    font-family: 'JetBrains Mono', 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  /* Inline code with subtle glow */
  .markdown-content :not(pre) > code {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.6));
    color: #5eead4;
    padding: 0.25em 0.5em;
    border-radius: 0.375rem;
    font-size: 0.9em;
    border: 1px solid rgba(94, 234, 212, 0.3);
    box-shadow: 0 0 10px rgba(94, 234, 212, 0.1);
  }

  /* Beautiful blockquotes */
  .markdown-content blockquote {
    border-left: 4px solid;
    border-image: linear-gradient(180deg, #5eead4, #3b82f6) 1;
    padding-left: 1.5rem;
    margin-top: 2em;
    margin-bottom: 2em;
    font-style: italic;
    color: #cbd5e1;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.5), rgba(51, 65, 85, 0.3));
    padding: 1.5rem;
    border-radius: 0.5rem;
    position: relative;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }

  .markdown-content blockquote::before {
    content: '"';
    position: absolute;
    top: -10px;
    left: 10px;
    font-size: 4rem;
    color: rgba(94, 234, 212, 0.2);
    font-family: Georgia, serif;
    line-height: 1;
  }

  .markdown-content blockquote p {
    margin-top: 0;
    margin-bottom: 0;
  }

  /* Sleek tables */
  .markdown-content table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 2em;
    margin-bottom: 2em;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  }

  .markdown-content th,
  .markdown-content td {
    border: 1px solid rgba(51, 65, 85, 0.5);
    padding: 1rem;
    text-align: left;
  }

  .markdown-content th {
    background: linear-gradient(135deg, #1e293b, #334155);
    color: #5eead4;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.05em;
  }

  .markdown-content tbody tr {
    background-color: rgba(30, 41, 59, 0.3);
    transition: background-color 0.2s ease;
  }

  .markdown-content tbody tr:hover {
    background-color: rgba(51, 65, 85, 0.5);
  }

  .markdown-content tr:nth-child(even) {
    background-color: rgba(30, 41, 59, 0.5);
  }

  .markdown-content tr:nth-child(even):hover {
    background-color: rgba(51, 65, 85, 0.6);
  }

  /* Gradient horizontal rule */
  .markdown-content hr {
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, #5eead4, #3b82f6, transparent);
    margin-top: 3em;
    margin-bottom: 3em;
  }

  /* Images with hover effect */
  .markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: 0.75rem;
    margin-top: 2em;
    margin-bottom: 2em;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .markdown-content img:hover {
    transform: scale(1.02);
    box-shadow: 0 12px 32px rgba(94, 234, 212, 0.3);
  }

  /* Enhanced strong text */
  .markdown-content strong {
    background: linear-gradient(135deg, #f1f5f9 0%, #5eead4 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
  }

  /* Elegant emphasis */
  .markdown-content em {
    font-style: italic;
    color: #cbd5e1;
  }

  /* Task lists with custom checkboxes */
  .markdown-content input[type="checkbox"] {
    appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #5eead4;
    border-radius: 0.25rem;
    margin-right: 0.5rem;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .markdown-content input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #5eead4, #3b82f6);
    border-color: #3b82f6;
  }

  .markdown-content input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #0f172a;
    font-weight: bold;
    font-size: 0.875rem;
  }
</style>
