---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";
import CaseDetail from "../../components/CaseDetail";
import Footer from "../../components/Footer.astro";
import { getImage } from "astro:assets";

export async function getStaticPaths() {
  const cases = await getCollection("cases");
  return cases.map((caseEntry: any) => ({
    params: { slug: caseEntry.id },
    props: { caseEntry },
  }));
}

const { caseEntry } = Astro.props;
const { Content } = await render(caseEntry);

const serializedImages = await Promise.all(
  caseEntry.data.images.map(async (img: any) => {
    if (typeof img.src === "object") {
      const optimized = await getImage({
        src: img.src,
        format: "webp",
        quality: "high",
      });
      return {
        src: optimized.src,
        attributes: optimized.attributes,
        alt: img.alt,
        stage: img.stage,
      };
    }
    return {
      src: typeof img.src === "string" ? img.src : img.src.src,
      alt: img.alt,
      stage: img.stage,
    };
  }),
);

const caseData = {
  ...caseEntry.data,
  images: serializedImages,
  date: caseEntry.data.date.toISOString(),
  id: caseEntry.id,
};

const categoryLabels: Record<string, string> = {
  restorations: "Restorations",
  endodontics: "Endodontics",
  "fixed-prosthodontics": "Fixed Prosthodontics",
  extractions: "Extractions",
  periodontics: "Periodontics",
  other: "Other",
};

const outcomeColors: Record<string, string> = {
  excellent: "text-emerald-400 border-emerald-500/30 bg-emerald-500/10",
  good: "text-blue-400 border-blue-500/30 bg-blue-500/10",
  satisfactory: "text-amber-400 border-amber-500/30 bg-amber-500/10",
  "needs-follow-up": "text-orange-400 border-orange-500/30 bg-orange-500/10",
};

// Helper to determine active grid columns based on data presence
const hasChiefComplaint = !!caseEntry.data.chiefComplaint;
const hasDiagnosis = !!caseEntry.data.diagnosis;
const hasTreatment = !!caseEntry.data.treatment;
const hasMaterials =
  caseEntry.data.materials && caseEntry.data.materials.length > 0;

const activeInfoCount = [
  hasChiefComplaint,
  hasDiagnosis,
  hasTreatment,
  hasMaterials,
].filter(Boolean).length;
---

<BaseLayout
  title={`${caseEntry.data.title} | Dr. Muhammad Atef`}
  description={`Dental case: ${caseEntry.data.title}`}
>
  <!-- Background Ambience -->
  <div class="fixed inset-0 z-0 pointer-events-none">
    <div
      class="absolute top-[-20%] left-[-20%] w-[60%] h-[60%] bg-teal-900/10 blur-[150px] rounded-full mix-blend-screen"
    >
    </div>
    <div
      class="absolute bottom-[-20%] right-[-20%] w-[60%] h-[60%] bg-indigo-900/10 blur-[150px] rounded-full mix-blend-screen"
    >
    </div>
  </div>

  <!-- Navigation -->
  <nav
    class="fixed top-0 w-full z-50 bg-slate-950/80 backdrop-blur-xl border-b border-white/5"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <a
          href={import.meta.env.BASE_URL}
          class="group flex items-center gap-2 text-slate-400 hover:text-white transition-colors"
        >
          <div
            class="w-6 h-6 rounded-full bg-slate-900 border border-white/10 flex items-center justify-center group-hover:border-teal-500/50 transition-colors"
          >
            <svg
              class="w-3 h-3 transition-transform group-hover:-translate-x-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
          </div>
          <span class="font-medium tracking-wide text-xs uppercase">Back</span>
        </a>
        <div class="flex items-center gap-4">
          <span
            class="px-2 py-0.5 text-[10px] font-medium tracking-wider uppercase text-slate-400 border border-white/5 rounded-full bg-white/5"
          >
            {categoryLabels[caseEntry.data.category]}
          </span>
        </div>
      </div>
    </div>
  </nav>

  <main class="relative z-10 pt-24 pb-16">
    <!-- Header Section -->
    <header class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mb-12 text-center">
      <div
        class="inline-flex items-center justify-center gap-2 px-2.5 py-0.5 rounded-full bg-teal-500/10 border border-teal-500/20 text-teal-400 text-xs font-medium mb-6"
      >
        <span class="relative flex h-1.5 w-1.5">
          <span
            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-400 opacity-75"
          ></span>
          <span
            class="relative inline-flex rounded-full h-1.5 w-1.5 bg-teal-500"
          ></span>
        </span>
        Case Study
      </div>

      <h1
        class="text-3xl md:text-5xl font-serif font-medium text-slate-100 mb-6 leading-tight tracking-tight"
      >
        {caseEntry.data.title}
      </h1>

      <div
        class="flex flex-wrap items-center justify-center gap-3 text-xs text-slate-400"
      >
        <div
          class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/5 border border-white/5"
        >
          <svg
            class="w-3.5 h-3.5 opacity-70"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          {
            caseEntry.data.date.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          }
        </div>

        {
          caseEntry.data.toothNumber && (
            <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/5 border border-white/5">
              <span class="opacity-70">ðŸ¦·</span>
              <span>Tooth #{caseEntry.data.toothNumber}</span>
            </div>
          )
        }

        {
          caseEntry.data.outcome && (
            <div
              class={`flex items-center gap-1.5 px-3 py-1.5 rounded-full border ${outcomeColors[caseEntry.data.outcome]}`}
            >
              <span>{caseEntry.data.outcome.replace("-", " ")}</span>
            </div>
          )
        }
      </div>
    </header>

    <!-- Gallery Component -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
      <CaseDetail client:load caseData={caseData} />
    </div>

    <!-- Content Area -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      {
        activeInfoCount > 0 && (
          <div
            class={`grid grid-cols-1 ${
              activeInfoCount === 1
                ? "md:grid-cols-1"
                : activeInfoCount === 2
                  ? "md:grid-cols-2"
                  : activeInfoCount === 3
                    ? "md:grid-cols-3"
                    : "md:grid-cols-2 lg:grid-cols-2"
            } gap-px bg-slate-800/50 border border-slate-800 rounded-xl overflow-hidden mb-12 shadow-xl shadow-black/10 text-sm`}
          >
            {/* Chief Complaint */}
            {hasChiefComplaint && (
              <div class="bg-slate-900/40 p-5 hover:bg-slate-800/40 transition-colors group">
                <h3 class="text-[10px] font-bold text-teal-500 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                  <svg
                    class="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                    />
                  </svg>
                  Chief Complaint
                </h3>
                <p class="text-slate-300 leading-relaxed font-light">
                  {caseEntry.data.chiefComplaint}
                </p>
              </div>
            )}

            {/* Diagnosis */}
            {hasDiagnosis && (
              <div class="bg-slate-900/40 p-5 hover:bg-slate-800/40 transition-colors group">
                <h3 class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                  <svg
                    class="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                  Diagnosis
                </h3>
                <p class="text-slate-300 leading-relaxed font-light">
                  {caseEntry.data.diagnosis}
                </p>
              </div>
            )}

            {/* Treatment */}
            {hasTreatment && (
              <div class="bg-slate-900/40 p-5 hover:bg-slate-800/40 transition-colors group">
                <h3 class="text-[10px] font-bold text-purple-500 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                  <svg
                    class="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                    />
                  </svg>
                  Treatment Plan
                </h3>
                <p class="text-slate-300 leading-relaxed font-light">
                  {caseEntry.data.treatment}
                </p>
              </div>
            )}

            {/* Materials */}
            {hasMaterials && (
              <div class="bg-slate-900/40 p-5 hover:bg-slate-800/40 transition-colors group">
                <h3 class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                  <svg
                    class="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                    />
                  </svg>
                  Materials
                </h3>
                <ul class="space-y-1">
                  {caseEntry.data.materials.map((m: string) => (
                    <li class="flex items-start gap-2 text-slate-300 font-light text-sm">
                      <span class="mt-1.5 w-1 h-1 bg-amber-500 rounded-full shrink-0" />
                      {m}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        )
      }

      <!-- Markdown Content -->
      <article class="editorial-content mb-16">
        <Content />
      </article>

      <!-- Key Insights Section (Learnings, Follow-up, Difficulties) -->
      {
        (caseEntry.data.learnings ||
          (caseEntry.data.difficulties &&
            caseEntry.data.difficulties.length > 0) ||
          caseEntry.data.followUp) && (
          <div class="grid gap-8 border-t border-slate-800 pt-12">
            {caseEntry.data.learnings && (
              <div class="relative pl-6 border-l-2 border-emerald-500/50">
                <h3 class="text-base font-serif text-emerald-400 mb-2 flex items-center gap-2">
                  Key Learnings
                </h3>
                <p class="text-slate-300 leading-relaxed text-sm">
                  {caseEntry.data.learnings}
                </p>
              </div>
            )}

            {caseEntry.data.difficulties &&
              caseEntry.data.difficulties.length > 0 && (
                <div class="relative pl-6 border-l-2 border-amber-500/50">
                  <h3 class="text-base font-serif text-amber-400 mb-2">
                    Challenges
                  </h3>
                  <ul class="space-y-1">
                    {caseEntry.data.difficulties.map((d: string) => (
                      <li class="text-slate-300 flex items-start gap-2 text-sm">
                        <span class="text-amber-500 mt-1.5">â€¢</span> {d}
                      </li>
                    ))}
                  </ul>
                </div>
              )}

            {caseEntry.data.followUp && (
              <div class="relative pl-6 border-l-2 border-blue-500/50">
                <h3 class="text-base font-serif text-blue-400 mb-2">
                  Follow-up Plan
                </h3>
                <p class="text-slate-300 leading-relaxed text-sm">
                  {caseEntry.data.followUp}
                </p>
              </div>
            )}
          </div>
        )
      }

      {/* Tags */}
      {
        caseEntry.data.tags && caseEntry.data.tags.length > 0 && (
          <div class="mt-12 flex flex-wrap gap-2 justify-center border-t border-slate-800 pt-8">
            {caseEntry.data.tags.map((tag: string) => (
              <span class="px-2.5 py-1 bg-slate-900 border border-slate-800 text-slate-500 rounded-md text-[10px] uppercase tracking-wide">
                #{tag}
              </span>
            ))}
          </div>
        )
      }
    </div>
  </main>
  <Footer />
</BaseLayout>

<style is:global>
  /* Custom Scrollbar */
  ::-webkit-scrollbar {
    width: 6px;
  }
  ::-webkit-scrollbar-track {
    background: #020617;
  }
  ::-webkit-scrollbar-thumb {
    background: #1e293b;
    border-radius: 3px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #334155;
  }

  /* Editorial Content Styles */
  .editorial-content {
    color: #e2e8f0; /* Slate 200 for better contrast */
    font-size: 1.125rem; /* 18px */
    line-height: 1.8;
    max-width: 65ch; /* Optimal reading length */
  }

  .editorial-content h1,
  .editorial-content h2,
  .editorial-content h3 {
    color: #f8fafc; /* Slate 50 */
    font-family: var(--font-playfair-display), serif;
    font-weight: 500;
    margin-top: 2.5em;
    margin-bottom: 0.8em;
    line-height: 1.2;
    letter-spacing: -0.01em;
  }

  .editorial-content h1 {
    font-size: 2.5rem;
  }

  .editorial-content h2 {
    font-size: 2rem;
    position: relative;
    padding-bottom: 0.5em;
    margin-top: 3em;
  }

  /* Decorative underline for h2 */
  .editorial-content h2::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(
      90deg,
      #2dd4bf,
      #0f766e
    ); /* Teal 400 to Teal 700 */
    border-radius: 2px;
  }

  .editorial-content h3 {
    font-size: 1.5rem;
    color: #2dd4bf; /* Teal 400 */
    margin-top: 2em;
  }

  .editorial-content p {
    margin-bottom: 1.75em;
  }

  .editorial-content ul {
    margin-bottom: 2em;
    list-style-type: none;
    padding-left: 0;
  }

  .editorial-content li {
    position: relative;
    padding-left: 1.5em;
    margin-bottom: 0.75em;
  }

  .editorial-content li::before {
    content: "â†’";
    position: absolute;
    left: 0;
    color: #2dd4bf; /* Teal 400 */
    font-weight: bold;
    opacity: 0.8;
  }

  .editorial-content blockquote {
    border-left: 4px solid #0f766e; /* Darker teal border */
    background: rgba(15, 118, 110, 0.1); /* Subtle background */
    padding: 1.5em 2em;
    margin: 2.5em 0;
    font-style: italic;
    color: #94a3b8;
    font-size: 1.1em;
    border-radius: 0 12px 12px 0;
  }

  .editorial-content strong {
    color: #f1f5f9; /* Near white for emphasis */
    font-weight: 700;
  }

  .editorial-content a {
    color: #2dd4bf;
    text-decoration: none;
    border-bottom: 1px solid rgba(45, 212, 191, 0.3);
    transition: all 0.2s;
    font-weight: 500;
  }

  .editorial-content a:hover {
    border-bottom-color: #2dd4bf;
    background: rgba(45, 212, 191, 0.1);
  }

  /* Image improvements within content */
  .editorial-content img {
    border-radius: 12px;
    box-shadow:
      0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
    margin: 2em 0;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
</style>
