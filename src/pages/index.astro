---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import CaseGallery from '../components/CaseGallery';
import HeroSection from '../components/HeroSection.astro';
import CategoryFilter from '../components/CategoryFilter';
import StatsSection from '../components/StatsSection.astro';
import AboutSection from '../components/AboutSection.astro';
import Footer from '../components/Footer.astro';

const allCases = await getCollection('cases');
const sortedCases = allCases.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const allCategories = [
  { id: 'all', name: 'All Cases', icon: 'ðŸ¦·' },
  { id: 'restorations', name: 'Restorations', icon: 'ðŸ”§' },
  { id: 'endodontics', name: 'Endodontics', icon: 'ðŸ”¬' },
  { id: 'fixed-prosthodontics', name: 'Fixed Prosthodontics', icon: 'ðŸ‘‘' },
  { id: 'extractions', name: 'Extractions', icon: 'ðŸ©¹' },
  { id: 'periodontics', name: 'Periodontics', icon: 'ðŸŒ¿' },
  { id: 'other', name: 'Other', icon: 'ðŸ“‹' },
];

// Serialize images for client components - image() schema returns ImageMetadata objects
const casesData = sortedCases.map(c => ({
  id: c.id,
  ...c.data,
  images: c.data.images.map((img: any) => ({
    src: typeof img.src === 'string' ? img.src : img.src.src,
    alt: img.alt,
    stage: img.stage,
  })),
  date: c.data.date.toISOString(),
}));

// Calculate stats
const totalCases = allCases.length;
const categoryStats = allCategories.slice(1).map(cat => ({
  ...cat,
  count: allCases.filter(c => c.data.category === cat.id).length
}));

// Filter categories with at least one case for the gallery
const categoriesWithCases = [
  allCategories[0], // Always include "All Cases"
  ...allCategories.slice(1).filter(cat => 
    allCases.some(c => c.data.category === cat.id)
  )
];
---

<BaseLayout title="Dr. Zahrawi | Dental Portfolio">
    <HeroSection />
    <StatsSection totalCases={totalCases} categoryStats={categoryStats} />
    
    <main id="cases" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-serif font-semibold text-slate-100 mb-4">
          Clinical Case Gallery
        </h2>
        <p class="text-slate-400 max-w-2xl mx-auto">
          Browse through documented cases showcasing various dental procedures with detailed notes on techniques, challenges, and outcomes.
        </p>
      </div>
      
      <CaseGallery 
        client:load 
        cases={casesData} 
        categories={categoriesWithCases}
      />
    </main>
    
    <AboutSection />
    <Footer />
</BaseLayout>
